<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interaktywna wyszukiwarka SOR</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    /* Global styles */
    body { 
      font-family: 'Roboto', sans-serif; 
      background-color: #121212; 
      color: #e0e0e0; 
      margin: 20px; 
      max-width: 800px; 
      transition: background .3s, color .3s; 
    }
    .light { background-color: #f5f5f5; color: #121212; }
    h1, p { text-align: center; }

    /* Formularz w gridzie */
    .form-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 8px; 
      margin-bottom: 16px; 
    }
    .input-container { position: relative; }
    label { display: block; margin-bottom: 4px; font-weight: 500; }
    input { 
      width: 100%; 
      padding: 6px; 
      border: 1px solid #333; 
      border-radius: 4px; 
      background-color: #1e1e1e; 
      color: #e0e0e0; 
    }
    .light input { background-color: #fff; color: #121212; }
    
    button { 
      padding: 8px 16px; 
      border: none; 
      border-radius: 4px; 
      background-color: #bb86fc; 
      color: #121212; 
      cursor: pointer; 
    }
    button:hover { background-color: #9b68ea; }

    /* Autocomplete */
    .autocomplete-suggestions {
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0;
      background-color: #1e1e1e; 
      border: 1px solid #333;
      max-height: 200px; 
      overflow-y: auto; 
      z-index: 10;
    }
    .suggestion-item { padding: 8px; cursor: pointer; }
    .suggestion-item:hover { background-color: #333; }

    /* Wyniki wyszukiwania */
    .result-card {
      background-color: #1e1e1e; 
      padding: 15px; 
      margin-bottom: 15px; 
      border-radius: 6px;
    }
    .summary-row {
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      border-bottom: 1px solid #333; 
      padding-bottom: 10px;
    }
    .primary-field {
      background: rgba(187,134,252,0.2); 
      padding: 5px 10px; 
      border-radius: 4px;
    }
    .detail-row { 
      display: none; 
      padding-top: 10px; 
    }
    .price-container { margin-top: 10px; }
    .price-result {
      margin-top: 5px; 
      font-style: italic; 
      color: #bb86fc;
      word-wrap: break-word; 
      max-width: 300px;
    }
    .price-spinner {
      border: 3px solid #1e1e1e; 
      border-top: 3px solid #bb86fc;
      border-radius: 50%; 
      width: 18px; 
      height: 18px;
      animation: spin 0.7s linear infinite; 
      margin-left: 8px;
    }
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }

    .pagination { 
      display: flex; 
      justify-content: center; 
      gap: 8px; 
      margin-top: 16px; 
    }

    @media(max-width:600px){
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <button onclick="toggleTheme()">Przełącz motyw</button>
  <h1>Interaktywna wyszukiwarka SOR</h1>
  <p>Wpisz fragment i kliknij „Wyszukaj”. Wyniki pojawią się jako karty.</p>

  <!-- Formularz ułożony w gridzie -->
  <div class="form-grid">
    <div class="input-container">
      <label for="uprawaInput">Uprawa:</label>
      <input id="uprawaInput" placeholder="np. ziemniak">
    </div>
    <div class="input-container">
      <label for="agrofagInput">Agrofag:</label>
      <input id="agrofagInput" placeholder="np. stonka ziemniaczana">
    </div>
    <div class="input-container">
      <label for="nazwaInput">Nazwa środka:</label>
      <input id="nazwaInput" placeholder="np. Aceplan">
    </div>
    <div class="input-container">
      <label for="subInput">Substancja czynna:</label>
      <input id="subInput" placeholder="np. acetamipryd">
    </div>
  </div>

  <button onclick="wyszukaj()">Wyszukaj</button>
  <div id="results"></div>
  <div class="pagination" id="pagination"></div>

  <script>
    const API_BASE = "https://sor.onrender.com";
    const PAGE_SIZE = 20;
    let cache = {}, currentPage = 1, allResults = [];

    // Debounce
    function debounce(fn, delay = 200) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      }
    }

    // Toggle light/dark theme
    function toggleTheme() {
      document.body.classList.toggle('light');
    }

    // Fetch distinct values for autocomplete (zapisuje do cache i localStorage)
    async function fetchDistinct(col) {
      if (cache[col]) return cache[col];
      const ls = localStorage.getItem(col);
      if (ls) return cache[col] = JSON.parse(ls);
      const res = await fetch(`${API_BASE}/distinct?col=${col}`);
      const vals = (await res.json()).distinct_values || [];
      localStorage.setItem(col, JSON.stringify(vals));
      return cache[col] = vals;
    }

    // Inicjalizacja autocomplete dla pól
    async function initAutocomplete() {
      const map = {
        uprawaInput: "uprawa",
        agrofagInput: "agrofag",
        nazwaInput: "nazwa",
        subInput: "Substancja_czynna"
      };
      for (const [id, col] of Object.entries(map)) {
        const input = document.getElementById(id);
        const suggest = document.createElement("div");
        suggest.className = "autocomplete-suggestions";
        input.parentNode.appendChild(suggest);
        const values = await fetchDistinct(col);
        input.addEventListener("input", debounce(() => {
          suggest.innerHTML = "";
          const q = input.value.toLowerCase();
          if (!q) return;
          values.filter(v => v.toLowerCase().includes(q)).slice(0, 10)
            .forEach(v => {
              const div = document.createElement("div");
              div.className = "suggestion-item";
              div.textContent = v;
              div.onclick = () => { input.value = v; suggest.innerHTML = ""; };
              suggest.appendChild(div);
            });
        }));
        input.addEventListener("blur", () => setTimeout(() => { suggest.innerHTML = ""; }, 150));
      }
    }

    // Wyszukiwanie wyników
    async function wyszukaj() {
      const up = document.getElementById("uprawaInput").value.trim();
      const ag = document.getElementById("agrofagInput").value.trim();
      const na = document.getElementById("nazwaInput").value.trim();
      const su = document.getElementById("subInput").value.trim();
      const params = [];
      if (up) params.push(`uprawa=${encodeURIComponent(up)}`);
      if (ag) params.push(`agrofag=${encodeURIComponent(ag)}`);
      if (na) params.push(`nazwa=${encodeURIComponent(na)}`);
      if (su) params.push(`Substancja_czynna=${encodeURIComponent(su)}`);
      const url = `${API_BASE}/search-all${params.length ? `?${params.join("&")}` : ""}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        allResults = json.results || [];
        currentPage = 1;
        renderPage();
      } catch (e) {
        console.error(e);
        document.getElementById("results").innerHTML = "<p>Błąd podczas wyszukiwania.</p>";
      }
    }

    // Renderowanie strony wyników z paginacją
    function renderPage() {
      const start = (currentPage - 1) * PAGE_SIZE;
      const page = allResults.slice(start, start + PAGE_SIZE);
      document.getElementById("results").innerHTML = page.map(rec => `
        <div class="result-card">
          <div class="summary-row">
            <div class="primary-field">${rec.Nazwa || ''}</div>
            <div class="primary-field">${rec.Agrofag || ''}</div>
            <div class="primary-field">${rec.Uprawa || ''}</div>
            <button onclick="toggleDetails(this)">+</button>
          </div>
          <div class="detail-row">
            ${Object.entries(rec).map(([k, v]) => `<p>${k}: ${v}</p>`).join('')}
          </div>
        </div>
      `).join('');
      const pages = Math.ceil(allResults.length / PAGE_SIZE);
      document.getElementById("pagination").innerHTML = Array.from({ length: pages }, (_, i) =>
        `<button ${i + 1 === currentPage ? "disabled" : ""} onclick="goto(${i + 1})">${i + 1}</button>`
      ).join('');
    }

    function goto(p) {
      currentPage = p;
      renderPage();
    }

    function toggleDetails(btn) {
      const det = btn.closest('.result-card').querySelector('.detail-row');
      if (det.style.display === "block") {
        det.style.display = "";
        btn.textContent = "+";
      } else {
        det.style.display = "block";
        btn.textContent = "-";
      }
    }

    window.onload = initAutocomplete;
  </script>
</body>
</html>
