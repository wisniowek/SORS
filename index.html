<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Interaktywna wyszukiwarka SOR</title>
<link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
<style>
  /* (kopiuj CSS z poprzedniego kodu — bez zmian) */
</style>
</head>
<body>
<button onclick="toggleTheme()">Przełącz motyw</button>
<h1>Interaktywna wyszukiwarka SOR</h1>
<div class="form-grid">
  <div class="input-container">
    <label>Uprawa:</label><input id="uprawaInput"><div id="uprawaSuggestions" class="autocomplete-suggestions"></div>
  </div>
  <div class="input-container">
    <label>Agrofag:</label><input id="agrofagInput"><div id="agrofagSuggestions" class="autocomplete-suggestions"></div>
  </div>
  <div class="input-container">
    <label>Nazwa środka:</label><input id="nazwaInput"><div id="nazwaSuggestions" class="autocomplete-suggestions"></div>
  </div>
  <div class="input-container">
    <label>Substancja czynna:</label><input id="subInput"><div id="subSuggestions" class="autocomplete-suggestions"></div>
  </div>
</div>
<button id="searchBtn">Wyszukaj</button>
<div id="results"></div>
<div id="pagination" class="pagination"></div>

<script>
const API_BASE="https://sor.onrender.com";
document.getElementById("searchBtn").addEventListener("click", wyszukaj);

// Autocomplete uses existing suggestion containers
async function initAutocomplete(){
  const map={ uprawaInput:"uprawa", agrofagInput:"agrofag", nazwaInput:"nazwa", subInput:"Substancja_czynna" };
  for(let id in map){
    const input=document.getElementById(id);
    const container=document.getElementById(id.replace("Input","")+"Suggestions");
    const vals=await fetch(`${API_BASE}/distinct?col=${map[id]}`).then(r=>r.json()).then(j=>j.distinct_values||[]);
    input.addEventListener("input",()=> {
      container.innerHTML="";
      const q=input.value.toLowerCase();
      vals.filter(v=>v.toLowerCase().includes(q)).slice(0,10)
        .forEach(v=>{
          const div=document.createElement("div");
          div.className="suggestion-item"; div.textContent=v;
          div.onclick=()=>{input.value=v; container.innerHTML="";};
          container.appendChild(div);
        });
    });
    input.addEventListener("blur", ()=>setTimeout(()=>container.innerHTML="",150));
  }
}

async function wyszukaj(){
  const params=["uprawa","agrofag","nazwa","Substancja_czynna"].map(col=>{
    const val=document.getElementById(col+"Input")?.value.trim();
    return val?`${col}=${encodeURIComponent(val)}`:null;
  }).filter(Boolean).join("&");
  const url=`${API_BASE}/search-all${params?"?"+params:""}`;
  try{
    const res=await fetch(url), json=await res.json();
    allResults=json.results||[];
    currentPage=1;
    renderPage();
  }catch(e){
    console.error(e);
    document.getElementById("results").innerHTML="<p>Błąd podczas wyszukiwania</p>";
  }
}

// Pagination & rendering (same as previous code)
let allResults=[], currentPage=1, PAGE_SIZE=20;
function renderPage(){
  const start=(currentPage-1)*PAGE_SIZE;
  const page=allResults.slice(start,start+PAGE_SIZE);
  document.getElementById("results").innerHTML = page.map(rec=>`
    <div class="result-card">
      <div class="summary-row">
        <div class="primary-field">${rec.Nazwa||""}</div>
        <div class="primary-field">${rec.Agrofag||""}</div>
        <div class="primary-field">${rec.Uprawa||""}</div>
        <button onclick="toggleDetails(this)">+</button>
      </div>
      <div class="detail-row">${Object.entries(rec).map(([k,v])=>`<p>${k}: ${v}</p>`).join("")}</div>
    </div>
  `).join("");
  const pages=Math.ceil(allResults.length/PAGE_SIZE);
  document.getElementById("pagination").innerHTML = Array.from({length:pages},(_,i)=>
    `<button ${i+1===currentPage?"disabled":""} onclick="goto(${i+1})">${i+1}</button>`
  ).join("");
}
function goto(p){ currentPage=p; renderPage(); }
function toggleDetails(btn){
  const det=btn.closest(".result-card").querySelector(".detail-row");
  det.style.display = det.style.display==="block"?"":"block";
  btn.textContent = det.style.display==="block"?"-":"+";
}
function toggleTheme(){ document.body.classList.toggle("light"); }

window.onload=initAutocomplete;
</script>
</body>
</html>
